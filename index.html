<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(6px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { margin: 0; font-size: 2rem; }
    main {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      max-width: 900px;
      margin: auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      animation: fadeIn 0.4s ease;
    }
    /* Form grid */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px 16px;
      align-items: end;
    }
    .form-grid label {
      display: block;
      font-weight: 600;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
    .form-grid input {
      width: 100%;
      max-width: 140px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    /* Global pill buttons */
    button {
      padding: 8px 16px;
      font-size: 0.9rem;
      border-radius: 20px;
      background: #4e54c8;
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background: #3b40a4;
      transform: scale(1.05);
    }
    button.danger { background: #e63946; }
    button.danger:hover { background: #c92a37; }
    /* Action buttons inside table */
    .action-group {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    .action-btn {
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .action-btn.edit { background: #2a9d8f; }
    .action-btn.edit:hover { background: #21867a; }
    .action-btn.delete { background: #e63946; }
    .action-btn.delete:hover { background: #c92a37; }
    /* Records header with export button */
    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .records-header h2 { margin: 0; }
    .export-btn { background: #4e54c8; }
    .export-btn:hover { background: #3b40a4; }
    /* Settings */
    .settings { text-align: right; margin: 10px; }
    .settings-toggle { background: #4e54c8; }
    .settings-toggle:hover { background: #3b40a4; }
    .settings-panel {
      display: none;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 10px;
    }
    .settings-panel .action-btn {
      padding: 6px 14px;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    .settings-panel .action-btn.save { background: #2a9d8f; }
    .settings-panel .action-btn.save:hover { background: #21867a; }
    .settings-panel .action-btn.reset { background: #e63946; }
    .settings-panel .action-btn.reset:hover { background: #c92a37; }
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    /* Toast */
    .toast {
      visibility: hidden;
      min-width: 200px;
      margin-left: -100px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 12px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      font-size: 1rem;
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
    }
    .toast.show { visibility: visible; opacity: 1; }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>
  <header><h1>‚õΩ Fuel Tracker</h1></header>

  <!-- Settings toggle -->
  <div class="settings">
    <button onclick="toggleSettings()" class="settings-toggle">‚öôÔ∏è Settings</button>
  </div>
  <!-- Settings panel -->
  <div class="settings-panel" id="settingsPanel">
    <label>Bike Mileage (km/L)</label>
    <input type="number" id="bikeMileage" step="0.1">
    <div class="action-group" style="margin-top:10px;">
      <button onclick="saveSettings()" class="action-btn save">üíæ Save Settings</button>
      <button onclick="resetApp()" class="action-btn reset">üóëÔ∏è Reset App</button>
    </div>
  </div>

  <main>
    <!-- Add/Edit Form -->
    <div class="card">
      <h2>Add / Edit Entry</h2>
      <form id="fuelForm" class="form-grid">
        <div><label>Meter Start</label><input type="number" id="meterStart" step="0.1" required></div>
        <div><label>Meter End</label><input type="number" id="meterEnd" step="0.1" required></div>
        <div><label>Distance</label><input type="number" id="distance" step="0.1" readonly></div>
        <div><label>Fuel (liters)</label><input type="number" id="fuel" step="0.1" required></div>
        <div><label>Cost (‚Çπ)</label><input type="number" id="cost" step="0.01" required></div>
        <div><label>Remaining KM</label><input type="number" id="remainingKm" step="0.1" readonly></div>
        <div style="grid-column: 1 / -1; text-align:center;">
          <button type="submit">üíæ Save Entry</button>
        </div>
      </form>
    </div>

    <!-- Records -->
    <div class="card">
      <div class="records-header">
        <h2>Records</h2>
        <button onclick="exportCSV()" class="export-btn">üì• Export CSV</button>
      </div>
      <table id="recordsTable">
        <thead>
          <tr>
            <th>Date</th><th>Start</th><th>End</th><th>Distance</th>
            <th>Fuel</th><th>Cost</th><th>Remaining KM</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Monthly Summary -->
    <div class="card">
      <h2>Monthly Summaries</h2>
      <div id="monthlySummary"></div>
    </div>
  </main>

  <div id="toast" class="toast">‚úÖ Saved successfully</div>

  <script>
    let BIKE_MILEAGE = Number(localStorage.getItem('bikeMileage')) || 40;
    let records = JSON.parse(localStorage.getItem('fuelRecords')) || [];
    let editIndex = -1;

    const num = (v, def = 0) => { v = Number(v); return Number.isFinite(v) ? v : def; };
    const roundN = (v, n = 1) => Number(num(v, 0).toFixed(n));

    function migrateRecords() {
      let changed = false;
      records = records.map(r => {
        const start = num(r.start);
        const end = num(r.end);
        const distance = num(r.distance);
        const fuel = num(r.fuel);
        const cost = num(r.cost);
        let remainingKm = r.remainingKm;
        if (!Number.isFinite(remainingKm)) {
          remainingKm = roundN((fuel * BIKE_MILEAGE) - distance, 1);
          changed = true;
        }
        return { ...r, start, end, distance, fuel, cost, remainingKm };
      });
      if (changed) localStorage.setItem('fuelRecords', JSON.stringify(records));
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date')?.remove(); // remove hidden date if any
      migrateRecords();
      renderRecords(); renderSummaries();
      document.getElementById('bikeMileage').value = BIKE_MILEAGE;
    });

    document.getElementById('meterEnd').addEventListener('input', () => { calcDistance(); calcRemainingKm(); });
    document.getElementById('meterStart').addEventListener('input', () => { calcDistance(); calcRemainingKm(); });
    document.getElementById('fuel').addEventListener('input', calcRemainingKm);

    function calcDistance() {
      let start = num(document.getElementById('meterStart').value);
      let end = num(document.getElementById('meterEnd').value);
      let dist = end - start;
      document.getElementById('distance').value = dist > 0 ? dist.toFixed(1) : 0;
    }

    function calcRemainingKm() {
      let distance = num(document.getElementById('distance').value);
      let fuel = num(document.getElementById('fuel').value);
      let possible_km = fuel * BIKE_MILEAGE;
      let remaining_km = possible_km - distance;
      document.getElementById('remainingKm').value = remaining_km > 0 ? remaining_km.toFixed(1) : 0;
    }

    document.getElementById('fuelForm').addEventListener('submit', e => {
      e.preventDefault();
      let start = roundN(document.getElementById('meterStart').value, 1);
      let end = roundN(document.getElementById('meterEnd').value, 1);
      if(end < start){ alert('End meter must be greater than start meter'); return; }
      let distance = roundN(end - start, 1);
      let fuel = roundN(document.getElementById('fuel').value, 1);
      let cost = roundN(document.getElementById('cost').value, 2);
      let remainingKm = roundN(document.getElementById('remainingKm').value, 1);

      let date = new Date().toISOString().split('T')[0];
      let record = {date, start, end, distance, fuel, cost, remainingKm};
      if(editIndex >= 0){ records[editIndex] = record; editIndex = -1; }
      else { records.push(record); }
      localStorage.setItem('fuelRecords', JSON.stringify(records));
      showToast(); e.target.reset();
      renderRecords(); renderSummaries();
    });

    function renderRecords(){
      let tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = '';
      records.forEach((r,i) => {
        const start = num(r.start); const end = num(r.end);
        const distance = num(r.distance); const fuel = num(r.fuel);
        const cost = num(r.cost);
        const remaining = Number.isFinite(r.remainingKm) ? num(r.remainingKm) : roundN((fuel * BIKE_MILEAGE) - distance, 1);
        let row = `<tr>
          <td>${r.date || ''}</td>
          <td>${start.toFixed(1)}</td>
          <td>${end.toFixed(1)}</td>
          <td>${distance.toFixed(1)}</td>
          <td>${fuel.toFixed(1)}</td>
          <td>‚Çπ${cost.toFixed(2)}</td>
          <td>${remaining.toFixed(1)}</td>
          <td>
            <div class="action-group">
              <button onclick="editRecord(${i})" class="action-btn edit">‚úèÔ∏è Edit</button>
              <button onclick="deleteRecord(${i})" class="action-btn delete">üóëÔ∏è Delete</button>
            </div>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    function renderSummaries(){
      let summaryDiv = document.getElementById('monthlySummary');
      summaryDiv.innerHTML = '';
      let grouped = {};
      records.forEach(r => {
        let month = (r.date || '').substring(0,7);
        if(!grouped[month]) grouped[month] = {distance:0,fuel:0,cost:0,remaining:0};
        const d = num(r.distance); const f = num(r.fuel); const c = num(r.cost);
        const rem = Number.isFinite(r.remainingKm) ? num(r.remainingKm) : roundN((f * BIKE_MILEAGE) - d, 1);
        grouped[month].distance += d; grouped[month].fuel += f;
        grouped[month].cost += c; grouped[month].remaining += rem;
      });
      for(let m in grouped){
        const g = grouped[m];
        const avgMileage = g.fuel > 0 ? (g.distance / g.fuel).toFixed(2) : '‚Äî';
        summaryDiv.innerHTML += `<p><b>${m}</b>: 
          ${g.distance.toFixed(1)} km, 
          ${g.fuel.toFixed(1)} L, 
          ‚Çπ${g.cost.toFixed(2)}, 
          Mileage: ${avgMileage} km/L, 
          Remaining: ${g.remaining.toFixed(1)} km</p>`;
      }
    }

    function editRecord(i){
      let r = records[i];
      document.getElementById('meterStart').value = num(r.start).toFixed(1);
      document.getElementById('meterEnd').value = num(r.end).toFixed(1);
      document.getElementById('distance').value = num(r.distance).toFixed(1);
      document.getElementById('fuel').value = num(r.fuel).toFixed(1);
      document.getElementById('cost').value = num(r.cost).toFixed(2);
      document.getElementById('remainingKm').value = num(r.remainingKm).toFixed(1);
      editIndex = i;
    }

    function deleteRecord(i){
      if(confirm('Delete this record?')){
        records.splice(i,1);
        localStorage.setItem('fuelRecords', JSON.stringify(records));
        renderRecords(); renderSummaries();
      }
    }

    function exportCSV(){
      let csv = 'Date,Start,End,Distance,Fuel,Cost,Remaining KM\n';
      records.forEach(r => {
        csv += `${r.date},${r.start},${r.end},${r.distance},${r.fuel},${r.cost},${r.remainingKm}\n`;
      });
      let blob = new Blob([csv], { type: 'text/csv' });
      let link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'fuel-records.csv';
      link.click();
    }

    function showToast(){
      let toast = document.getElementById('toast');
      toast.className = 'toast show';
      setTimeout(() => toast.className = 'toast', 2000);
    }

    function toggleSettings(){
      let p = document.getElementById('settingsPanel');
      p.style.display = p.style.display === 'block' ? 'none':'block';
    }

    function saveSettings(){
      const mileageInput = num(document.getElementById('bikeMileage').value, 40);
      BIKE_MILEAGE = mileageInput > 0 ? mileageInput : 40;
      localStorage.setItem('bikeMileage', BIKE_MILEAGE);
      alert('Bike mileage updated to ' + BIKE_MILEAGE + ' km/L');
      calcRemainingKm(); renderRecords(); renderSummaries();
    }

    function resetApp(){
      if(confirm('This will delete ALL records. Continue?')){
        records = [];
        localStorage.removeItem('fuelRecords');
        renderRecords(); renderSummaries();
      }
    }
  </script>
</body>
</html>
